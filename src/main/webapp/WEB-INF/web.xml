<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://java.sun.com/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
                  http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
         version="2.5">

    <display-name>Portal callback</display-name>

    <servlet>
        <description>Callback servlet</description>
        <servlet-name>ready</servlet-name>
        <servlet-class>org.cilogon.portal.servlets.ReadyServlet</servlet-class>
        <load-on-startup>0</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>ready</servlet-name>
        <url-pattern>/ready</url-pattern>
    </servlet-mapping>

    <servlet>
        <description>Request a certificate</description>
        <display-name>startRequest</display-name>
        <servlet-name>startRequest</servlet-name>
        <servlet-class>org.dataone.portal.servlets.StartRequest</servlet-class>
        <load-on-startup>0</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>startRequest</servlet-name>
        <url-pattern>/startRequest</url-pattern>
    </servlet-mapping>

    <servlet>
        <description>Servlet to display success page</description>
        <display-name>success</display-name>
        <servlet-name>success</servlet-name>
        <servlet-class>org.dataone.portal.servlets.D1SuccessServlet</servlet-class>
        <load-on-startup>0</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>success</servlet-name>
        <url-pattern>/success</url-pattern>
    </servlet-mapping>
    
    <servlet>
        <description>Servlet to display test page</description>
        <display-name>test</display-name>
        <servlet-name>test</servlet-name>
        <servlet-class>org.dataone.portal.servlets.D1TestServlet</servlet-class>
        <load-on-startup>0</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>test</servlet-name>
        <url-pattern>/test</url-pattern>
    </servlet-mapping>

	<servlet>
        <description>Servlet to edit account info</description>
        <display-name>identity</display-name>
        <servlet-name>identity</servlet-name>
        <servlet-class>org.dataone.portal.servlets.IdentityServlet</servlet-class>
        <load-on-startup>0</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>identity</servlet-name>
        <url-pattern>/identity</url-pattern>
    </servlet-mapping>
    
    <servlet>
        <description>failure page</description>
        <display-name>failure</display-name>
        <servlet-name>failureServlet</servlet-name>
        <servlet-class>org.cilogon.portal.servlets.FailureServlet</servlet-class>
        <load-on-startup>0</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>failureServlet</servlet-name>
        <url-pattern>/failure</url-pattern>
    </servlet-mapping>

    <!--
       The next section should be uncommented if you install the portal to
       Tomcat as a stand-alone application, i.e., there is no Apache
       involved.
       Comment out this section if you access the application
       through Apache.
    -->

    <security-constraint>
        <web-resource-collection>
            <web-resource-name>portalSecurity</web-resource-name>
            <url-pattern>/*</url-pattern>
            <http-method>GET</http-method>
            <http-method>POST</http-method>
        </web-resource-collection>
        <user-data-constraint>
            <transport-guarantee>CONFIDENTIAL</transport-guarantee>
        </user-data-constraint>
    </security-constraint>


    <!--
       This section regulates access to the setup pages. It *must* be done separately from any other
       constraints. Since Tomcat processes its constraints sequentially do not change the order
       of them!
    -->

    <security-constraint>
        <web-resource-collection>
            <web-resource-name>setupPages</web-resource-name>
            <url-pattern>*.jsp</url-pattern>
        </web-resource-collection>
        <auth-constraint>
            <role-name>cilogon-admin</role-name>
        </auth-constraint>
    </security-constraint>


    <security-role>
        <description>
            The role that is required to configure the servlet. This must be added to tomcat-users.xml
        </description>
        <role-name>cilogon-admin</role-name>
    </security-role>

    <login-config>
        <auth-method>BASIC</auth-method>
    </login-config>
    <!--  NOCVS  comment this out if needed before commit
    If you need to specify a configuration file, put the full path here. Make sure you have all the proper permissions.
    -->
   <context-param>
       <param-name>org.cilogon.config.portal</param-name>
       <param-value>/var/lib/tomcat6/webapps/portal/WEB-INF/cfg.rdf</param-value>
   </context-param>
   
	<!-- NOTE: can override to use their test server: https://test.cilogon.org -->
	<context-param>
		<param-name>org.cilogon.debug.server</param-name>
		<param-value>https://test.cilogon.org</param-value>
	</context-param>
	
	<!-- NOTE: can override the CN URL for DataONE -->
	<context-param>
		<param-name>D1Client.CN_URL</param-name>
		<param-value>https://cn.dataone.org/cn</param-value>
	</context-param>
	
	<context-param>
		<param-name>org.dataone.transactionStore.maxAttempts</param-name>
		<param-value>10</param-value>
	</context-param>
	
     
    <!--
    Specify the name of the configuration within the configuration file, if needed. Default behavior
    is to assume that there is exactly on in  the file one and use that if
    no name is supplied. Otherwise the named configuration
    will be used or an exception will be thrown if no such configuration is found.
    -->
    <!--
        <context-param>
        <param-name>org.cilogon.config.name</param-name>
        <param-value>memory configuration</param-value>
    </context-param>
    -->
      
	<!-- Hazelcast Session replication -->
	<filter>
	  <filter-name>hazelcast-filter</filter-name>
	  <filter-class>com.hazelcast.web.WebFilter</filter-class>
	  <!-- point to DataONE hazelcast config -->           
	  <init-param>
	      <param-name>config-location</param-name>
	      <param-value>/etc/dataone/portal/hazelcast.xml</param-value>
	  </init-param>
	  <!--
	      Name of the distributed map storing
	      your web session objects
	  -->
	  <init-param>
	      <param-name>map-name</param-name>
	      <param-value>d1PortalSessions</param-value>
	  </init-param>
	  <!--
	      How is your load-balancer configured?
	      stick-session means all requests of a session
	      is routed to the node where the session is first created.
	      This is excellent for performance.
	      If sticky-session is set to false, when a session is updated
	      on a node, entry for this session on all other nodes is invalidated.
	      You have to know how your load-balancer is configured before
	      setting this parameter. Default is true.
	  -->
	  <init-param>
	      <param-name>sticky-session</param-name>
	      <param-value>true</param-value>
	  </init-param>
	  <!--
	      Are you debugging? Default is false.
	  -->
	    <init-param>
	        <param-name>debug</param-name>
	        <param-value>true</param-value>
	    </init-param>
            <init-param>
                <param-name>instance-name</param-name>
                <param-value>dataonePortalInstance</param-value>
            </init-param>

	</filter>
	<filter-mapping>
	    <filter-name>hazelcast-filter</filter-name>
	    <url-pattern>/*</url-pattern>
	    <dispatcher>FORWARD</dispatcher>
	    <dispatcher>INCLUDE</dispatcher>
	    <dispatcher>REQUEST</dispatcher>
	</filter-mapping>
	
	<!-- for session replication when deployed with round robin DNS -->
	<listener>
	    <listener-class>com.hazelcast.web.SessionListener</listener-class>
	</listener>
	
	<!-- use this override for SSL JDBC -->
	<listener>
		<listener-class>org.cilogon.portal.servlets.PortalBootstrapper</listener-class>
	</listener>
	
</web-app>
